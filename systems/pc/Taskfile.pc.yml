version: '3'

vars:
  ROOT_DIR: '{{.ROOT_DIR | default "."}}'
  BIN_DIR: '{{.ROOT_DIR}}/.bin'
  SRC_DIR: '{{.ROOT_DIR}}/.src'
  EXE_EXT: '{{if eq OS "windows"}}.exe{{end}}'
  PC_BIN: '{{.BIN_DIR}}/process-compose{{.EXE_EXT}}'
  PC_BIN_NAME: 'process-compose{{.EXE_EXT}}'
  PC_SRC_DIR: '{{.SRC_DIR}}/process-compose'
  PC_REPO: 'github.com/F1bonacc1/process-compose'

env:
  GOWORK: 'off'

tasks:
  default:
    internal: true
    cmds:
      - task: debug:self

  "debug:self":
    desc: Print all vars for debugging
    cmds:
      - echo "=== Process Compose Vars ==="
      - echo "ROOT_DIR={{.ROOT_DIR}}"
      - echo "BIN_DIR={{.BIN_DIR}}"
      - echo "SRC_DIR={{.SRC_DIR}}"
      - echo "PC_BIN={{.PC_BIN}}"
      - echo "PC_SRC_DIR={{.PC_SRC_DIR}}"
      - echo ""
      - echo "=== Env ==="
      - echo "PC_PORT=$PC_PORT"
    silent: true

  "deps:clone":
    desc: Clone process-compose repo
    status:
      - test -d {{.PC_SRC_DIR}}
    cmds:
      - mkdir -p {{.SRC_DIR}}
      - git clone --depth 1 https://{{.PC_REPO}}.git {{.PC_SRC_DIR}}

  "deps:install":
    desc: Build process-compose from source
    deps: ["deps:clone"]
    status:
      - test -f {{.PC_BIN}}
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - cd {{.PC_SRC_DIR}} && go build -o {{.PC_BIN}} .

  "deps:clean":
    desc: Remove process-compose binary and source
    cmds:
      - rm -f {{.PC_BIN}}
      - rm -rf {{.PC_SRC_DIR}}

  up:
    desc: Start
    deps: ["deps:install"]
    cmds:
      - '{{.PC_BIN}} up --port $PC_PORT'

  "up:bg":
    desc: Start NATS + Simulator in background
    deps: ["deps:install"]
    cmds:
      - '{{.PC_BIN}} up -D -t=false --port $PC_PORT'

  "up:headless":
    desc: Start NATS + Simulator without TUI (for CI/testing)
    deps: ["deps:install"]
    cmds:
      - '{{.PC_BIN}} up -t=false --port $PC_PORT'

  down:
    desc: Stop all process-compose services
    cmds:
      - '{{.PC_BIN}} down'

  attach:
    desc: Attach to running process-compose TUI
    cmds:
      - '{{.PC_BIN}} attach'

  logs:
    desc: Show logs for a process (usage task pc:logs -- <process>)
    cmds:
      - '{{.PC_BIN}} process logs {{.CLI_ARGS}}'

  "logs:all":
    desc: Tail all process logs
    cmds:
      - 'tail -f /var/folders/pj/*/T/process-compose-*.log 2>/dev/null || echo "No log file found"'
